# Мониторинг и управление соединениями БД

## Проблема
При превышении лимита соединений MySQL (50 на пользователя) возникают ошибки `ER_TOO_MANY_USER_CONNECTIONS`, что приводит к невозможности входа и работы с системой.

## Реализованные решения

### 1. Улучшенный мониторинг пула (`lib/db.ts`)
- Автоматический мониторинг каждые 30 секунд в development режиме
- Отслеживание статистики: активные/свободные соединения, очередь запросов
- Предупреждения при превышении 80% лимита
- Логирование всех операций acquire/release

### 2. API endpoint для мониторинга (`/api/admin/db-stats`)
Доступен только для superadmin. Показывает:
- Статистику пула соединений
- Список активных процессов БД
- Детали каждого соединения (ID, время работы, запрос)

**Использование:**
```bash
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:3000/api/admin/db-stats
```

### 3. Скрипты для управления соединениями

#### Проверка соединений
```bash
npm run check-db-connections
```
Показывает:
- Текущее количество соединений
- Лимиты сервера
- Детали каждого соединения
- Предупреждения о долгих запросах (>60s)
- Предупреждения о простаивающих соединениях (>10s)

#### Закрытие соединений
```bash
npm run close-db-connections
```
Закрывает все соединения текущего пользователя, кроме текущего.

### 4. Проверка API endpoints
Все API endpoints в `app/api/**` используют `pool.execute()`, который автоматически:
- Получает соединение из пула
- Выполняет запрос
- Возвращает соединение в пул

**Нет использования `pool.getConnection()` без `release()`** - это правильно.

## Рекомендации

### При превышении лимита соединений:

1. **Проверить активные соединения:**
   ```bash
   npm run check-db-connections
   ```

2. **Закрыть неиспользуемые соединения:**
   ```bash
   npm run close-db-connections
   ```

3. **Или через панель хостинга:**
   - Зайти в phpMyAdmin или панель управления БД
   - Открыть "Processes" / "Процессы"
   - Найти соединения пользователя БД
   - Закрыть старые/неиспользуемые соединения

4. **Перезапустить сервер разработки:**
   ```bash
   # Остановить (Ctrl+C)
   # Запустить снова
   npm run dev
   ```

### Мониторинг в реальном времени:

1. **Через консоль сервера:**
   - В development режиме каждые 30 секунд выводятся статистики пула
   - При каждом acquire/release выводятся логи

2. **Через API endpoint:**
   - Регулярно проверять `/api/admin/db-stats`
   - Отслеживать рост активных соединений

### Настройки пула:

Текущие настройки в `lib/db.ts`:
- `connectionLimit: 3` - максимум 3 соединения в пуле
- `idleTimeout: 1800000` - закрытие неактивных соединений через 30 минут
- `queueLimit: 0` - без ограничения очереди

**Важно:** При лимите 50 соединений на пользователя, использование пула с лимитом 3 безопасно, но если запущено несколько процессов Next.js, каждый будет иметь свой пул.

## Предотвращение проблем

1. **Всегда используйте `pool.execute()`** вместо `pool.getConnection()`
2. **Не создавайте соединения вручную** через `mysql.createConnection()`
3. **Мониторьте логи** на наличие предупреждений о превышении лимита
4. **Регулярно проверяйте** активные соединения через скрипты
5. **Перезапускайте сервер** после длительной работы

## Экстренный доступ

Если БД недоступна из-за превышения лимита, система автоматически переключается на in-memory режим для входа `admin@padelo2.com / admin123`. Это позволяет войти и закрыть соединения через панель хостинга.

