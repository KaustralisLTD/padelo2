# Анализ проблемы с соединениями БД

## Текущая ситуация
- **Лимит соединений:** 50 на пользователя `foldis00_padelo2`
- **Текущее состояние:** Лимит превышен, новые соединения невозможны
- **Причина:** Множественные процессы держат соединения открытыми

## Почему так много соединений?

### 1. Пул соединений в каждом процессе
Каждый процесс (dev server, build, scripts) создает свой пул:
- Dev server: до 3 соединений
- Build процесс: до 3 соединений  
- Каждый скрипт: может создать пул или прямое соединение
- **Итого:** 3-10+ соединений на процесс

### 2. Соединения не закрываются автоматически
- Пул соединений (`mysql2/promise`) **не закрывает** соединения автоматически
- Соединения возвращаются в пул после использования, но остаются открытыми
- Пул живет до завершения процесса
- **Проблема:** Если процесс "завис" или работает долго, соединения остаются открытыми

### 3. Множественные запуски
- Dev server запущен
- Build процесс может быть запущен
- Скрипты выполняются параллельно
- **Итого:** 10-30+ соединений легко

### 4. Неоптимизированные запросы (ИСПРАВЛЕНО)
- Было: `Promise.all` с N запросов = N соединений одновременно
- Стало: Один запрос с `IN (...)` = 1 соединение
- Файл: `app/api/tournament/[id]/schedule/route.ts`

## Почему лимит только 50?

Это стандартный лимит для shared hosting. Хостинг-провайдеры ограничивают ресурсы:
- **Shared hosting:** 20-50 соединений
- **VPS:** 100-200 соединений
- **Dedicated:** 500+ соединений

**Решение:** Можно запросить увеличение лимита у хостинг-провайдера (обычно платно).

## Почему соединения не закрываются?

### Пул соединений (mysql2/promise)
```typescript
const pool = mysql.createPool({ connectionLimit: 3 });
// Соединения создаются при первом запросе
// И остаются открытыми до закрытия пула
pool.end(); // Закрывает все соединения
```

**Проблема:** В Next.js API routes пул создается один раз и живет до перезапуска сервера.

### Прямые соединения
```typescript
const connection = await mysql.createConnection({...});
// Должно быть закрыто явно:
await connection.end();
```

**Хорошо:** Скрипты правильно закрывают соединения (`connection.end()`).

## Решения

### 1. Уменьшен connectionLimit ✅
- Было: 10
- Стало: 3
- Файл: `lib/db.ts`

### 2. Добавлены настройки idle timeout ✅
- `idleTimeout: 300000` (5 минут)
- `maxIdle: 2`
- Файл: `lib/db.ts`

### 3. Оптимизированы запросы ✅
- Один запрос вместо N запросов
- Файл: `app/api/tournament/[id]/schedule/route.ts`

### 4. Защита админа от удаления ✅
- Нельзя удалить `admin@padelo2.com`
- Файл: `lib/users.ts`

### 5. Автоматическое создание админа ✅
- Админ создается при инициализации БД
- Обновляется при каждом запуске
- Файл: `lib/users.ts`

## Что делать сейчас?

### Вариант 1: Подождать (рекомендуется)
Соединения закроются автоматически через 5-10 минут (idle timeout).

### Вариант 2: Остановить все процессы
1. Остановите dev server (`Ctrl+C`)
2. Закройте все терминалы
3. Подождите 2-3 минуты
4. Попробуйте создать админа

### Вариант 3: Создать админа через phpMyAdmin (ОБХОД ЛИМИТА)
1. Откройте phpMyAdmin
2. Выполните SQL из `scripts/create-admin-sql.sql`
3. Админ будет создан напрямую в БД

## Долгосрочные решения

1. **Увеличить лимит соединений** у хостинг-провайдера
2. **Использовать connection pooling** на уровне приложения
3. **Мониторить соединения** регулярно
4. **Закрывать пулы** при завершении процессов

## Мониторинг соединений

```bash
# Проверить количество соединений
npm run close-db-connections

# Создать админа (после освобождения)
npm run create-admin-direct
```

## SQL для проверки соединений

```sql
-- Показать все соединения пользователя
SELECT 
    Id, 
    User, 
    Host, 
    db, 
    Command, 
    Time, 
    State, 
    LEFT(Info, 50) as Query
FROM information_schema.PROCESSLIST 
WHERE User = 'foldis00_padelo2'
ORDER BY Time DESC;
```

