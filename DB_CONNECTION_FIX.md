# Проблема с превышением лимита соединений БД

## Проблема
Пользователь БД `foldis00_padelo2` имеет лимит **50 соединений**, и этот лимит превышен.

## Причины
1. **Множественные процессы**: Dev server, build, scripts - каждый создает пул соединений
2. **Неоптимизированные запросы**: В `/api/tournament/[id]/schedule` используется `Promise.all` с множественными запросами
3. **Высокий connectionLimit**: Было установлено 10, что при нескольких процессах может дать 30-40+ соединений

## Решения

### 1. Уменьшен connectionLimit
- Было: `connectionLimit: 10`
- Стало: `connectionLimit: 3`
- Файл: `lib/db.ts`

### 2. Оптимизированы запросы в schedule route
- Было: `Promise.all` с N запросов (по одному на каждый матч)
- Стало: Один запрос с `IN (...)` для всех регистраций
- Файл: `app/api/tournament/[id]/schedule/route.ts`

### 3. Создан скрипт для прямого создания админа
- Файл: `scripts/create-admin-direct.ts`
- Использует прямое соединение, минуя пул
- Команда: `npm run create-admin-direct`

## Что делать сейчас

### Вариант 1: Подождать
Соединения автоматически закроются через некоторое время (обычно 8 часов idle). Подождите 10-15 минут и попробуйте снова.

### Вариант 2: Остановить все процессы
1. Остановите dev server (`Ctrl+C`)
2. Закройте все терминалы с запущенными скриптами
3. Подождите 1-2 минуты
4. Попробуйте: `npm run create-admin-direct`

### Вариант 3: Использовать админа в памяти
Админ автоматически создается в памяти при запуске сервера через `initializeDefaultAdmin()` в `lib/users.ts`. Это работает, но данные теряются при перезапуске.

## Рекомендации

1. **Используйте один процесс** для работы с БД одновременно
2. **Закрывайте соединения** после использования в скриптах
3. **Мониторьте соединения**: Используйте `npm run close-db-connections` для просмотра активных соединений

## Проверка соединений

```bash
# Проверить количество соединений
npm run close-db-connections

# Создать админа (после освобождения соединений)
npm run create-admin-direct
```

## Долгосрочное решение

Рассмотрите возможность увеличения лимита соединений у хостинг-провайдера или использование connection pooling на уровне приложения.

